$(document).ready(function(){function t(){if(l(),!h()){var t=$("#itemName").val(),i=$("#realm").val();if(""===t)$("#msg").html("物品名不能为空");else if($("#itemListByName").empty(),parseInt(t,10)==t){var o=t;e(i,o)}else a(i,t)}}function e(t,e){$.get("wow/item/id2/"+e,function(a){null!=a?i(t,e,a.name):$("#msg").html("通过ID找不到物品:"+e)})}function a(t,e){$.get("wow/item/list/name/"+encodeURIComponent(e),function(a){if(0===a.length)$("#msg").html("找不到物品:"+e);else if(1===a.length){var l=a[0];if(BnadeLocalStorage.addItem(BnadeLocalStorage.lsItems.item.key,e),0===l.itemBonus.length||1===l.itemBonus.length)i(t,l.id,e);else{$("#msg").html("物品:"+e+" 发现"+l.itemBonus.length+"种版本,请选择下列表中的一种来查询");var o="<table class='table table-striped'><thead><tr><th>ID</th><th>物品名</th><th>物品说明</th></tr></thead><tbody>";for(var n in l.itemBonus){var s=l.itemBonus[n];o+="<tr><td>"+l.id+"</td><td><a href='javascript:void(0)' id='itemBonus"+n+l.id+"' itemId='"+l.id+"' bl='"+s.bonusList+"'>"+l.name+"</a></td><td>"+Bnade.getBonusDesc(s.bonusList)+"</td></tr>"}o+="</tbody></table>",$("#itemListByName").html(o);for(var n in l.itemBonus){var s=l.itemBonus[n];$("#itemBonus"+n+l.id).click(function(){var e=$(this).attr("itemId")+"?bl="+$(this).attr("bl"),a=$(this).html();i(t,e,a)})}}}else if(a.length>1){BnadeLocalStorage.addItem(BnadeLocalStorage.lsItems.item.key,e),$("#msg").html("发现"+a.length+"个有相同名字的物品,请选择下列表中的一个物品来查询");var o="<table class='table table-striped'><thead><tr><th>ID</th><th>物品名</th><th>物品等级</th></tr></thead><tbody>";for(var n in a){var l=a[n];o+="<tr><td>"+l.id+"</td><td><a href='javascript:void(0)' id='"+l.id+"'>"+l.name+"</a></td><td>"+l.itemLevel+"</td></tr>"}o+="</tbody></table>",$("#itemListByName").html(o);for(var n in a){var l=a[n];$("#"+l.id).click(function(){var e=$(this).attr("id"),a=$(this).html();i(t,e,a)})}}}).fail(function(){$("#msg").html("查询出错")})}function l(){$("#past24CtlDiv").hide(),$("#past24Msg").html(""),$("#pastWeekCtlDiv").hide(),$("#pastWeekMsg").html(""),$("#allRealmCtlDiv").hide(),$("#allRealmMsg").html(""),$("#msg").html(""),$("#itemDetail").html("")}function i(t,e,a){$("#showAllTbl").hide(),$("#showAllA").html("显示全部+"),u(e),""!==t&&(o(t,e,a),r(t,e,a)),m(e,a);var l=window.location.protocol+"//"+window.location.host+window.location.pathname+"?itemName="+encodeURIComponent(a);null!=t&&""!=t&&(l+="&realm="+encodeURIComponent(t)),$("#queryByUrl").html("快速查询URL: <a href='"+l+"'>"+l+"</a>")}function o(t,e,a){$("#past24Msg").html("正在查询24小时内数据,请稍等..."),$.get("wow/auction/past24/realm/"+encodeURIComponent(t)+"/item/id/"+e,function(t){if(201===t.code||404===t.code)$("#past24Msg").html("查询24小时内数据失败:"+t.errorMessage),$("#past24CtlDiv").hide();else{$("#past24CtlDiv").show();var e=[],l=[],i=[],o=0,s=0,r=0,m=0,s=0;for(var h in t){var c=t[h],d=toDecimal(c.minBuyout/1e4);l[h]=d,d>=10&&(l[h]=parseInt(d)),e[h]=new Date(c.lastModified).format("hh:mm"),i[h]=c.totalQuantity,r+=d,m+=c.totalQuantity,(0==o||o>d)&&(o=d),(0==s||d>s)&&(s=d)}r=toDecimal(r/t.length),r>=10&&(r=parseInt(r)),o>=10&&(o=parseInt(o)),s>=10&&(s=parseInt(s)),m=parseInt(m/t.length);var g=toDecimal(t[t.length-1].minBuyout/1e4);g>=10&&(g=parseInt(g)),$("#past24MinBuyout").html(o),$("#past24MaxBuyout").html(s),$("#past24AvgBuyout").html(r),$("#past24AvgQuantity").html(m),$("#past24LatestBuyout").html(g),n("past24Container","24小时内价格走势",a,e,l,o,s,!0,"areaspline",i,"spline"),$("#past24Msg").html("")}})}function n(t,e,a,l,i,o,n,s,r,m,h){$("#"+t).highcharts({chart:{zoomType:"xy",ignoreHiddenSeries:!1},title:{text:e},subtitle:{text:a},xAxis:[{categories:l,crosshair:!0,labels:{enabled:s}}],yAxis:[{title:{text:"数量",style:{color:Highcharts.getOptions().colors[8]}},labels:{format:"{value}个",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0},{labels:{format:"{value}G",style:{color:Highcharts.getOptions().colors[1]}},title:{text:"价格",style:{color:Highcharts.getOptions().colors[0]}},min:o,max:n}],tooltip:{shared:!0},series:[{name:"数量",type:h,data:m,color:Highcharts.getOptions().colors[8],marker:{enabled:!1},tooltip:{valueSuffix:"个"}},{name:"价格",type:r,yAxis:1,data:i,color:Highcharts.getOptions().colors[0],marker:{enabled:!1},tooltip:{valueSuffix:"G"}}]})}function s(t,e,a,l,i,o,n){$("#"+t).highcharts({chart:{type:"heatmap",marginTop:40,marginBottom:80,inverted:!0},title:{text:e},xAxis:{categories:["0点-6点","6点-12点","12点-18点","18点-24点"]},yAxis:{categories:a,title:null},colorAxis:{min:i,minColor:"#FFFFFF",maxColor:Highcharts.getOptions().colors[n]},legend:{align:"right",layout:"vertical",margin:0,verticalAlign:"top",y:25,symbolHeight:280},tooltip:{formatter:function(){return"<b>"+this.series.yAxis.categories[this.point.y]+"</b>的<b>"+this.series.xAxis.categories[this.point.x]+"</b><br>"+o+"<b>"+this.point.value+"</b><br>"}},series:[{name:o,borderWidth:1,data:l,dataLabels:{enabled:!0,color:"#000000"}}]})}function r(t,e,a){$("#pastWeekMsg").html("正在查询物品所有历史数据, 请稍等..."),$.get("wow/auction/history/realm/"+encodeURIComponent(t)+"/item/id/"+e,function(e){if(201===e.code||404===e.code)$("#pastWeekMsg").html("查询历史数据失败:"+e.errorMessage),$("#pastWeekCtlDiv").hide();else{BnadeLocalStorage.addItem(BnadeLocalStorage.lsItems.realm.key,t),$("#pastWeekCtlDiv").show();var l=[],i=[],o=[],n=0;for(var r in e){var m=e[r][0]+288e5,h=Bnade.getGold(e[r][1]),c=e[r][2];o[r]=e[r][1],l[r]=[],l[r][0]=m,l[r][1]=h,i[r]=[],i[r][0]=m,i[r][1]=c,n+=c}var d=Bnade.getResult(o),g=Bnade.getGold(d.max),u=Bnade.getGold(d.min),p=Bnade.getGold(d.avg),f=2;p>10&&(f=0),$("#historyMin").html(u),$("#historyMax").html(g),$("#historyAvg").html(p),$("#historyAvgQuantity").html(parseInt(n/e.length)),Highcharts.setOptions({lang:{months:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],shortMonths:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],weekdays:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"]}}),$("#pastWeekContainer").highcharts("StockChart",{rangeSelector:{selected:4,inputEnabled:!1,buttons:[{type:"week",count:1,text:"周"},{type:"month",count:1,text:"月"},{type:"month",count:4,text:"季"},{type:"year",count:1,text:"年"},{type:"all",text:"全部"}]},credits:{enabled:!1},navigator:{enabled:!1},scrollbar:{enabled:!1},title:{text:"["+a+"]在服务器["+t+"]的历史价格信息"},xAxis:{type:"datetime",dateTimeLabelFormats:{second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%m-%d",week:"%m-%d",month:"%m",year:"%Y"}},yAxis:[{title:{text:"价格",style:{color:Highcharts.getOptions().colors[0]}},labels:{format:"{value}G",style:{color:Highcharts.getOptions().colors[1]},align:"right",x:-3},height:"60%",lineWidth:2,min:u,max:g},{title:{text:"数量",style:{color:Highcharts.getOptions().colors[8]}},labels:{format:"{value}个",style:{color:Highcharts.getOptions().colors[1]},align:"right",x:-3},top:"65%",height:"35%",offset:0,lineWidth:2}],tooltip:{},series:[{name:"价格",type:"areaspline",data:l,tooltip:{valueDecimals:f,valueSuffix:"G"},fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,Highcharts.getOptions().colors[0]],[1,Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get("rgba")]]}},{name:"数量",type:"column",yAxis:1,data:i,color:Highcharts.getOptions().colors[8],tooltip:{valueSuffix:"个"}}]});for(var v=[],y=[],B=[],b=-1,I=-1,w=0,r=e.length-1;r>=0;r--){var m=e[r][0],x=new Date(m-1).getDay();if(-1===I)I=x,w++;else if(I!==x){if(++w>7)break;I=x}b=r}for(var k=0,M=0,A=0,C=0,D=0,L=0,S=0,H=0,R=1,r=b;r<e.length;r++){var m=e[r][0],h=e[r][1],c=e[r][2],O=Bnade.getGold(h),c=c;(0===M||M>O)&&(M=O),(0===C||O>C)&&(C=O),(0===A||A>c)&&(A=c),S+=h,H+=c,R++;var W=new Date(m).format("hh:mm"),x=new Date(m-1).getDay();0===x&&(x=7),"00:00"===W&&(y[k]=[3,x-1,O],B[k++]=[3,x-1,c]),"06:00"===W&&(y[k]=[0,x-1,O],B[k++]=[0,x-1,c]),"12:00"===W&&(y[k]=[1,x-1,O],B[k++]=[1,x-1,c]),"18:00"===W&&(y[k]=[2,x-1,O],B[k++]=[2,x-1,c],v[x-1]="星期"+weekFormat(x))}D=Bnade.getGold(S/R),L=parseInt(H/R),$("#pastWeekMinBuyout").html(M),$("#pastWeekMaxBuyout").html(C),$("#pastWeekAvgBuyout").html(D),$("#pastWeekAvgQuantity").html(L),s("pastWeekBuyoutHeatMapContainer","一周内"+a+"价格热力图",v,y,u,"一口价",0),s("pastWeekQuantityHeatMapContainer","一周内"+a+"数量热力图",v,B,A,"数量",8),$("#pastWeekMsg").html("")}}).fail(function(){$("#pastWeekMsg").html("历史数据查询出错")})}function m(t,e){$("#allRealmMsg").html("正在查询所有服务器数据,请稍等..."),$.get("wow/auction/item/id/"+t,function(t){if(404==t.code)$("#allRealmMsg").html("查询所有服务器失败:"+t.errorMessage),$("#allRealmCtlDiv").hide();else{$("#allRealmCtlDiv").show(),t.sort(function(t,e){return t[1]-e[1]});var a=!0;$("#showAllA").click(function(){if(a){a=!1,$("#showAllTbl").show(),$("#showAllA").html("显示全部-"),$("#showAllBody").empty();for(var e in t){var l=t[e],i=Bnade.getConnectedRealms(l[0]),o="";""!=$("#realm").val()&&i.indexOf($("#realm").val())>=0&&(o="class='danger'");var n=Bnade.getGold(l[1]);$("#showAllBody").append("<tr "+o+"><td>"+(parseInt(e)+1)+"</td><td>"+i+"</td><td>"+n+"</td><td><a href='/ownerQuery.html?realm="+encodeURIComponent(l[0])+"&owner="+encodeURIComponent(l[2])+"'  target='_blank'>"+l[2]+"</a></td><td>"+leftTimeMap[l[5]]+"</td><td>"+l[3]+"</td><td>"+new Date(l[4]).format("MM-dd hh:mm:ss")+"</td></tr>")}}else a=!0,$("#showAllTbl").hide(),$("#showAllA").html("显示全部+")});var l=[],i=[],o=[],s=[],r=0;for(var m in t){var h=Bnade.getConnectedRealms(t[m][0]),c=t[m][1],d=(t[m][2],t[m][3]);t[m][4];s[m]=c,l[m]=h,i[m]=Bnade.getGold(c),o[m]=d,r+=d}var g=Bnade.getResult(s),u=Bnade.getGold(g.min),p=Bnade.getGold(g.max),f=Bnade.getGold(g.avg);$("#allMinBuyout").html(u),$("#allMaxBuyout").html(p),$("#allAvgBuyout").html(f),$("#allAvgQuantity").html(parseInt(r/t.length)),$("#allRealmMsg").html("所有服务器平均价格:"+f),n("allRealmContainer",e+"在各服务器的价格和数量",e,l,i,u,p>2*f?2*f:p,!1,"spline",o,"column"),$("#showAllA").click()}})}function h(){var t=$("#realm").val(),e=$("#itemName").val();if("realmCount"==t)if(parseInt(e)==e&&e>=0){var a=JSON.parse(localStorage.getItem(BnadeLocalStorage.lsItems.realm.key));a.length=e,localStorage.setItem(BnadeLocalStorage.lsItems.realm.key,JSON.stringify(a)),BnadeLocalStorage.refresh(),alert("服务器保存数量设置成功")}else alert("请在物品名框输入正确的正整数");else{if("itemCount"!=t)return!1;if(parseInt(e)==e&&e>=0){var a=JSON.parse(localStorage.getItem(BnadeLocalStorage.lsItems.item.key));a.length=e,localStorage.setItem(BnadeLocalStorage.lsItems.item.key,JSON.stringify(a)),BnadeLocalStorage.refresh(),alert("物品名保存数量设置成功")}else alert("请在物品名框输入正确的正整数")}return!0}function c(){$.get("wow/item/top10",function(t){if(0!=t.length){$("#topItemList").html("<li class='active'><a>热门物品Top10(测试中)</a></li>");for(var e in t)$("#topItemList").append("<li><a href='javascript:void(0)' id='topItem"+e+"' itemName='"+t[e].name+"'>"+(parseInt(e)+1)+" "+t[e].name+" <span class='badge'>"+t[e].count+"</span></a></li>"),$("#topItem"+e).click(function(){$("#itemName").val($(this).attr("itemName")),$("#queryBtn").click()})}})}function d(){var t=getUrlParam("realm"),e=getUrlParam("itemName");null!==e&&""!==e&&($("#realm").val(t),$("#itemName").val(e),$("#queryBtn").click())}function g(t){l(),$("#msg").html("正在模糊查询物品信息,请稍等..."),$.get("wow/item/fuzzy/name/"+encodeURIComponent(t),function(e){if(201===e.code)$("#msg").html("模糊查询失败:"+e.errorMessage);else if(0===e.length)$("#msg").html("找不到物品:"+t);else{$("#fuzzyItemsList").show(),$("#fuzzyItemsList").html("<li class='active'><a href='javascript:void(0)'>物品名</a></li>");for(var a in e){var l="fuzzyItem"+a;$("#fuzzyItemsList").append("<li><a href='javascript:void(0)' id='"+l+"'>"+e[a].name+"</a></li>"),$("#"+l).click(function(){$("#itemName").val($(this).html()),$("#queryBtn").click()})}$("#msg").html("")}})}function u(t){$("#itemDetail").html(""),$.get("wow/item/id/"+t,function(t){201===t.code?$("#msg").append("物品信息查询失败:"+t.errorMessage):$("#itemDetail").html(t)}).fail(function(){$("#msg").html("物品信息查询出错")})}$("#queryBtn").click(function(){t()});$("#itemFuzzyQueryBtn").click(function(){var t=$("#itemName").val();""==t?$("#msg").html("物品名不能为空"):g(t)}),!function(){$("#past24CtlDiv").hide(),$("#pastWeekCtlDiv").hide(),$("#allRealmCtlDiv").hide(),$("#fuzzyItemsList").hide(),d(),c()}()});